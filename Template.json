{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "DCENameAppRegistrations": {
            "type": "String",
            "defaultValue": "dce-AppRegistrationsInventory",
            "metadata": {
                "description": "Name of the Data Collection Endpoint"
            }
        },
        "DCRNameAppRegistrations": {
            "type": "String",
            "defaultValue": "dcr-AppRegistrationsInventory",
            "metadata": {
                "description": "Name of the Data Collection Rule"
            }
        },
        "logAnalyticsWorkspaceId": {
            "type": "String",
            "defaultValue": "73d0e3cb-8541-471d-8cc0-cbece4b569fc",
            "metadata": {
                "description": "Workspace ID of the Log Analytics workspace"
            }
        },
        "logAnalyticsWorkspaceName": {
            "type": "String",
            "defaultValue": "log-sentinel",
            "metadata": {
                "description": "Name of the Log Analytics workspace"
            }
        },
        "customTableNameNameAppRegistrations": {
            "type": "String",
            "defaultValue": "AppRegistrationsInventory",
            "metadata": {
                "description": "Custom table name without suffix, e.g., 'MyTable' will result in 'MyTable_CL'. ONLY alphabetic characters!"
            }
        },
        "LogicAppNameAppRegistrations": {
            "type": "String",
            "defaultValue": "logic-AppRegistrationsInventory",
            "metadata": {
                "description": "Name for the logic App. Microsofts recommends logic- as prefix"
            }
        },
        "UTCValue": {
            "type": "String",
            "defaultValue": "[utcNow()]",
            "metadata": {
                "description": "Used internally because of stupid Azure restrictions. Do not change."
            }
        }
    },
    "variables": {
        "DelayScriptName": "[concat('delayScript_', parameters('UTCValue'))]",
        "CustomTableName": "[concat(parameters('customTableNameNameAppRegistrations'), '_CL')]",
        "region":"[resourceGroup().location]"

    },
    "resources": [
        //Custom Table
        {
            "type": "Microsoft.OperationalInsights/workspaces/tables",
            "apiVersion": "2021-12-01-preview",
            "name": "[concat(parameters('logAnalyticsWorkspaceName'), '/', variables('CustomTableName'))]",
            "properties": {
                "schema": {
                    "name": "[concat(parameters('customTableNameNameAppRegistrations'), '_CL')]",
                    "columns": [
                        {
                            "name": "addIns",
                            "type": "dynamic"
                        },
                        {
                            "name": "api",
                            "type": "dynamic"
                        },
                        {
                            "name": "appId",
                            "type": "string"
                        },
                        {
                            "name": "applicationTemplateId",
                            "type": "dynamic"
                        },
                        {
                            "name": "appRoles",
                            "type": "dynamic"
                        },
                        {
                            "name": "certification",
                            "type": "dynamic"
                        },
                        {
                            "name": "createdDateTime",
                            "type": "datetime"
                        },
                        {
                            "name": "defaultRedirectUri",
                            "type": "dynamic"
                        },
                        {
                            "name": "deletedDateTime",
                            "type": "dynamic"
                        },
                        {
                            "name": "description",
                            "type": "dynamic"
                        },
                        {
                            "name": "disabledByMicrosoftStatus",
                            "type": "dynamic"
                        },
                        {
                            "name": "displayName",
                            "type": "string"
                        },
                        {
                            "name": "groupMembershipClaims",
                            "type": "dynamic"
                        },
                        {
                            "name": "id",
                            "type": "string"
                        },
                        {
                            "name": "identifierUris",
                            "type": "dynamic"
                        },
                        {
                            "name": "info",
                            "type": "dynamic"
                        },
                        {
                            "name": "isDeviceOnlyAuthSupported",
                            "type": "dynamic"
                        },
                        {
                            "name": "isFallbackPublicClient",
                            "type": "dynamic"
                        },
                        {
                            "name": "keyCredentials",
                            "type": "dynamic"
                        },
                        {
                            "name": "nativeAuthenticationApisEnabled",
                            "type": "dynamic"
                        },
                        {
                            "name": "notes",
                            "type": "dynamic"
                        },
                        {
                            "name": "optionalClaims",
                            "type": "dynamic"
                        },
                        {
                            "name": "parentalControlSettings",
                            "type": "dynamic"
                        },
                        {
                            "name": "passwordCredentials",
                            "type": "dynamic"
                        },
                        {
                            "name": "publicClient",
                            "type": "dynamic"
                        },
                        {
                            "name": "publisherDomain",
                            "type": "string"
                        },
                        {
                            "name": "requestSignatureVerification",
                            "type": "dynamic"
                        },
                        {
                            "name": "requiredResourceAccess",
                            "type": "dynamic"
                        },
                        {
                            "name": "samlMetadataUrl",
                            "type": "dynamic"
                        },
                        {
                            "name": "serviceManagementReference",
                            "type": "dynamic"
                        },
                        {
                            "name": "servicePrincipalLockConfiguration",
                            "type": "dynamic"
                        },
                        {
                            "name": "signInAudience",
                            "type": "string"
                        },
                        {
                            "name": "spa",
                            "type": "dynamic"
                        },
                        {
                            "name": "tags",
                            "type": "dynamic"
                        },
                        {
                            "name": "tokenEncryptionKeyId",
                            "type": "dynamic"
                        },
                        {
                            "name": "uniqueName",
                            "type": "dynamic"
                        },
                        {
                            "name": "verifiedPublisher",
                            "type": "dynamic"
                        },
                        {
                            "name": "web",
                            "type": "dynamic"
                        },
                        {
                            "name": "TimeGenerated",
                            "type": "datetime"
                        }
                    ]
                },
                "retentionInDays": 30
            }
        },
        //DCE
        {
            "type": "Microsoft.Insights/dataCollectionEndpoints",
            "apiVersion": "2021-09-01-preview",
            "name": "[parameters('DCENameAppRegistrations')]",
            "location": "[variables('region')]",
            "properties": {
                "networkAcls": {
                    "publicNetworkAccess": "Enabled"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('logAnalyticsWorkspaceName'), variables('CustomTableName'))]"
            ]
        },
        //DCR
        {
            "type": "Microsoft.Insights/dataCollectionRules",
            "apiVersion": "2021-09-01-preview",
            "name": "[parameters('DCRNameAppRegistrations')]",
            "location": "[variables('region')]",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('DCENameAppRegistrations'))]"
            ],
            "properties": {
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('DCENameAppRegistrations'))]",
                "destinations": {
                    "logAnalytics": [
                        {
                            "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                            "name": "[parameters('logAnalyticsWorkspaceId')]"
                        }
                    ]
                },
                "dataFlows": [
                    {
                        "streams": [
                            "[concat('Custom-', parameters('customTableNameNameAppRegistrations'),'_CL')]"
                        ],
                        "destinations": [
                            "[parameters('logAnalyticsWorkspaceId')]"
                        ],
                        "transformKql": "source\n| extend TimeGenerated = now()\n"
                    }
                ],
                "dataSources": {
                    "customLogs": [
                        {
                            "name": "customlogsource",
                            "streams": [
                                "[concat('Custom-', parameters('customTableNameNameAppRegistrations'),'_CL')]"
                            ],
                            "format": "json",
                            "compression": "none"
                        }
                    ]
                }
            }
        },
        //Logic App
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('LogicAppNameAppRegistrations')]",
            "location": "[variables('region')]",
            "dependsOn": [
                "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('DCRNameAppRegistrations'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "state": "Disabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        }
                    },
                    "triggers": {
                        "Recurrence": {
                            "recurrence": {
                                "interval": 24,
                                "frequency": "Hour"
                            },
                            "evaluatedRecurrence": {
                                "interval": 24,
                                "frequency": "Hour"
                            },
                            "type": "Recurrence"
                        }
                    },
                    "actions": {
                        "HTTP_GET_app_registrations": {
                            "runAfter": {},
                            "type": "Http",
                            "inputs": {
                                "uri": "https://graph.microsoft.com/v1.0/applications?$select=Property,addIns,api,appId,applicationTemplateId,appRoles,certification,createdDateTime,deletedDateTime,description,disabledByMicrosoftStatus,displayName,groupMembershipClaims,id,identifierUris,info,isDeviceOnlyAuthSupported,isFallbackPublicClient,keyCredentials,logo,nativeAuthenticationApisEnabled,notes,oauth2RequiredPostResponse,optionalClaims,parentalControlSettings,passwordCredentials,publicClient,publisherDomain,requestSignatureVerification,requiredResourceAccess,samlMetadataUrl,serviceManagementReference,servicePrincipalLockConfiguration,signInAudience,spa,tags,tokenEncryptionKeyId,uniqueName,verifiedPublisher,web",
                                "method": "GET",
                                "authentication": {
                                    "type": "ManagedServiceIdentity",
                                    "audience": "https://graph.microsoft.com"
                                }
                            },
                            "runtimeConfiguration": {
                                "paginationPolicy": {
                                    "minimumItemCount": 200
                                },
                                "contentTransfer": {
                                    "transferMode": "Chunked"
                                }
                            }
                        },
                        "HTTP_Send_to_Log_Ingestion_API": {
                            "runAfter": {
                                "Parse_JSON": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Http",
                            "inputs": {
                                "uri": "[concat(reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('DCENameAppRegistrations'))).logsIngestion.endpoint,'/dataCollectionRules/',reference(resourceId('Microsoft.Insights/dataCollectionRules', parameters('DCRNameAppRegistrations'))).immutableId,'/streams/Custom-',variables('CustomTableName'),'?api-version=2023-01-01')]",
                                //reference(resourceId('Microsoft.Insights/dataCollectionRules', parameters('DCRNameAppRegistrations'))).properties.dataCollectionRuleId
                                "method": "POST",
                                "body": "@body('Parse_JSON')?['value']",
                                "authentication": {
                                    "type": "ManagedServiceIdentity",
                                    "audience": "https://monitor.azure.com/"
                                }
                            },
                            "runtimeConfiguration": {
                                "contentTransfer": {
                                    "transferMode": "Chunked"
                                }
                            }
                        },
                        "Parse_JSON": {
                            "runAfter": {
                                "HTTP_GET_app_registrations": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ParseJson",
                            "inputs": {
                                "content": "@body('HTTP_GET_app_registrations')",
                                "schema": {
                                    "type": "object",
                                    "properties": {
                                        "body": {
                                            "type": "object",
                                            "properties": {
                                                "value": {
                                                    "type": "array",
                                                    "items": {
                                                        "type": "object",
                                                        "properties": {
                                                            "appId": {
                                                                "type": "string"
                                                            },
                                                            "applicationTemplateId": {},
                                                            "createdDateTime": {
                                                                "type": "string"
                                                            },
                                                            "deletedDateTime": {},
                                                            "description": {
                                                                "type": "string"
                                                            },
                                                            "disabledByMicrosoftStatus": {},
                                                            "displayName": {
                                                                "type": "string"
                                                            },
                                                            "groupMembershipClaims": {},
                                                            "id": {
                                                                "type": "string"
                                                            },
                                                            "identifierUris": {
                                                                "type": "array"
                                                            },
                                                            "isDeviceOnlyAuthSupported": {},
                                                            "isFallbackPublicClient": {},
                                                            "nativeAuthenticationApisEnabled": {},
                                                            "notes": {},
                                                            "publisherDomain": {
                                                                "type": "string"
                                                            },
                                                            "samlMetadataUrl": {},
                                                            "serviceManagementReference": {},
                                                            "signInAudience": {
                                                                "type": "string"
                                                            },
                                                            "tags": {
                                                                "type": "array",
                                                                "items": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "tokenEncryptionKeyId": {},
                                                            "uniqueName": {},
                                                            "certification": {},
                                                            "optionalClaims": {},
                                                            "requestSignatureVerification": {},
                                                            "servicePrincipalLockConfiguration": {},
                                                            "addIns": {
                                                                "type": "array"
                                                            },
                                                            "api": {
                                                                "type": "object",
                                                                "properties": {
                                                                    "acceptMappedClaims": {},
                                                                    "knownClientApplications": {
                                                                        "type": "array"
                                                                    },
                                                                    "requestedAccessTokenVersion": {},
                                                                    "oauth2PermissionScopes": {
                                                                        "type": "array"
                                                                    },
                                                                    "preAuthorizedApplications": {
                                                                        "type": "array"
                                                                    }
                                                                }
                                                            },
                                                            "appRoles": {
                                                                "type": "array"
                                                            },
                                                            "info": {
                                                                "type": "object",
                                                                "properties": {
                                                                    "logoUrl": {},
                                                                    "marketingUrl": {},
                                                                    "privacyStatementUrl": {},
                                                                    "supportUrl": {},
                                                                    "termsOfServiceUrl": {}
                                                                }
                                                            },
                                                            "keyCredentials": {
                                                                "type": "array"
                                                            },
                                                            "parentalControlSettings": {
                                                                "type": "object",
                                                                "properties": {
                                                                    "countriesBlockedForMinors": {
                                                                        "type": "array"
                                                                    },
                                                                    "legalAgeGroupRule": {
                                                                        "type": "string"
                                                                    }
                                                                }
                                                            },
                                                            "passwordCredentials": {
                                                                "type": "array"
                                                            },
                                                            "publicClient": {
                                                                "type": "object",
                                                                "properties": {
                                                                    "redirectUris": {
                                                                        "type": "array"
                                                                    }
                                                                }
                                                            },
                                                            "requiredResourceAccess": {
                                                                "type": "array"
                                                            },
                                                            "spa": {
                                                                "type": "object",
                                                                "properties": {
                                                                    "redirectUris": {
                                                                        "type": "array"
                                                                    }
                                                                }
                                                            },
                                                            "verifiedPublisher": {
                                                                "type": "object",
                                                                "properties": {
                                                                    "displayName": {},
                                                                    "verifiedPublisherId": {},
                                                                    "addedDateTime": {}
                                                                }
                                                            },
                                                            "web": {
                                                                "type": "object",
                                                                "properties": {
                                                                    "homePageUrl": {},
                                                                    "logoutUrl": {},
                                                                    "redirectUris": {
                                                                        "type": "array"
                                                                    },
                                                                    "implicitGrantSettings": {
                                                                        "type": "object",
                                                                        "properties": {
                                                                            "enableAccessTokenIssuance": {
                                                                                "type": "boolean"
                                                                            },
                                                                            "enableIdTokenIssuance": {
                                                                                "type": "boolean"
                                                                            }
                                                                        }
                                                                    },
                                                                    "redirectUriSettings": {
                                                                        "type": "array"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "required": [
                                                            "id"
                                                        ]
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {}
                    }
                }
            }
        },
        //wait 20 sec for Managed Identity Creation
        {
            "type": "Microsoft.Resources/deploymentScripts",
            "apiVersion": "2020-10-01",
            "name": "[variables('DelayScriptName')]",
            "location": "[variables('region')]",
            "kind": "AzureCLI",
            "properties": {
                "azCliVersion": "2.38.0",
                "timeout": "PT10M",
                "retentionInterval": "P1D",
                "scriptContent": "sleep 20",
                "forceUpdateTag": "[parameters('UTCValue')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Logic/workflows/', parameters('LogicAppNameAppRegistrations'))]"
            ]
        },
        //role assignment
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2022-04-01",
            "name": "[guid(resourceId('Microsoft.Insights/dataCollectionRules', parameters('DCRNameAppRegistrations')), 'logicAppRole')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deploymentScripts', variables('DelayScriptName'))]"
            ],
            "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '3913510d-42f4-4e42-8a64-420c390055eb')]", // Monitoring Metrics Publisher
                "principalId": "[reference(resourceId('Microsoft.Logic/workflows', parameters('LogicAppNameAppRegistrations')), '2019-05-01', 'Full').identity.principalId]",
                "principalType": "ServicePrincipal"
            },
            "scope": "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('DCRNameAppRegistrations'))]"
        }

    ],
    "outputs": {
        "logicAppManagedIdentityObjectId": {
        "type": "string",
        "value": "[reference(resourceId('Microsoft.Logic/workflows', parameters('LogicAppNameAppRegistrations')), '2019-05-01', 'Full').identity.principalId]"
        }
    }

}
